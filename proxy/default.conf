# This section is used for the default content when not redirecting to the confidential container
# Please not we could use a seperate container to handle this, but to keep this demo simple
# We just host a distinct web instance on the same server on port 8888
server {
    listen 8888;
    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }
}

# The reverse proxy conf itself
server {
    # We listen only on ssl ports, supporting http2
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    # We listen on localhost but we could use a hostheader
    server_name localhost;

    # We specify here the file location of the Cert/Key pair generated by openssl
    ssl_certificate /etc/ssl/certs/localhost.crt;
    ssl_certificate_key /etc/ssl/private/localhost.key;
    ssl_protocols TLSv1.2 TLSv1.1 TLSv1;

    # We specify here the basic authentication and the .htpasswd file location
    auth_basic "Private Website";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    # We setup the redirection of the default content to previous server
    location / {
        proxy_pass http://127.0.0.1:8888;
    }
    
    # THIS IS IT :  We setup the redirection for the specific /uj47G/ to the web 'confidential' container
    # location specify the part of the URL to serve
    location /uj47G/ {
        # We re-write the entire sub-content
        rewrite ^/uj47G(/.*)$ $1 break;
        # By redirecting to the external container named 'web' (in the yml composition)
        proxy_pass http://web:80;
    }
}
